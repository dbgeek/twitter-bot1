
version: 2

jobs:
    checkout_code:
        docker:
            - image: circleci/golang:1.12.4
        steps:
            - checkout:
                path:  /go/src/github.com/dbgeek/twitter-bot1
            - save_cache:
                key: v1-repo-{{ .Branch }}-{{ .Environment.CIRCLE_SHA1 }}
                paths:
                    - /go/src/github.com/dbgeek
    run_go_unit_tests:
        docker:
            - image: circleci/golang:1.12.4
        working_directory: /go/src/github.com/dbgeek/twitter-bot1/lambda/twitter-bot1
        environment:
            GO111MODULE: "on"
        steps:
            - restore_cache:
                key: v1-repo-{{ .Branch }}-{{ .Environment.CIRCLE_SHA1 }}
            - run:
                name: Update PATH and Define Environment Variable at Runtime
                command: |
                    echo 'export PATH=$HOME/venv/bin:$PATH' >> $BASH_ENV
            - run:
                name: running go test
                command: |
                    make test-all
    awscli_dependencies:
        docker:
            - image: circleci/golang:1.12.4
        working_directory: ~/
        steps:
            - restore_cache:
                key: v1-repo-{{ .Branch }}-{{ .Environment.CIRCLE_SHA1 }}
            - restore_cache:
                key: awscli-{{ checksum "/go/src/github.com/dbgeek/twitter-bot1/.circleci/requirements.txt" }}
            - run:
                name: install virtualenv
                command: |
                    pip install virtualenv
            - run:
                name: setup dependencies
                command: |
                    python -m virtualenv awscli
                    . awscli/bin/activate
                    pip install -r /go/src/github.com/dbgeek/twitter-bot1/.circleci/requirements.txt
            - save_cache: # special step to save dependency cache
                key: awscli-{{ checksum "/go/src/github.com/dbgeek/twitter-bot1/.circleci/requirements.txt" }}
                paths:
                    - "awscli"

workflows:
  version: 2
  build-and-deploy:
    jobs:
        - checkout_code
        - awscli_dependencies:
            requires:
              - checkout_code
        - run_go_unit_tests:
            requires:
              - awscli_dependencies
              - checkout_code